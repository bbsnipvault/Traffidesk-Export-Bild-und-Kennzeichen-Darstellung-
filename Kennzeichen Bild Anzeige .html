<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>CSV + Bilderpfad auswählen</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; margin-right: 10px; }
    .button.secondary { background-color: #008CBA; }
    .thumbnail { max-width: 200px; max-height: 150px; display: block; margin: auto; }
    .license-display { font-weight: bold; margin-top: 8px; text-align: center; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
</style>
</head>
<body>
<h1>CSV und Bilder anzeigen</h1>

<!-- Versteckte Inputs -->
<input type="file" id="csvFile" accept=".csv" style="display:none">
<input type="file" id="imagesFolder" webkitdirectory directory multiple style="display:none">

<!-- Buttons -->
<button id="selectCsvBtn" class="button">CSV auswählen</button>
<button id="selectImagesBtn" class="button secondary" disabled>Bilder-Ordner auswählen</button>

<p id="statusInfo">Keine Dateien geladen</p>

<table>
    <thead>
        <tr>
            <th>Nr.</th>
            <th>Bild + Kennzeichen</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        <tr><td colspan="2">Bitte CSV importieren</td></tr>
    </tbody>
</table>

<script>
const state = {
    csvData: [],
    images: [],
};

const csvInput = document.getElementById('csvFile');
const imgFolderInput = document.getElementById('imagesFolder');
const statusInfo = document.getElementById('statusInfo');
const tableBody = document.getElementById('tableBody');

document.getElementById('selectCsvBtn').addEventListener('click', () => csvInput.click());
document.getElementById('selectImagesBtn').addEventListener('click', () => imgFolderInput.click());

// CSV auswählen
csvInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        parseCSVData(ev.target.result);
        renderTable();
        document.getElementById('selectImagesBtn').disabled = false;
        statusInfo.textContent = `CSV geladen: ${file.name} (${state.csvData.length} Einträge)`;
    };
    reader.readAsText(file);
});

// Bilder-Ordner auswählen
imgFolderInput.addEventListener('change', (e) => {
    state.images = Array.from(e.target.files).filter(f => /\.(jpg|jpeg|png)$/i.test(f.name));
    renderTable();
    statusInfo.textContent += ` | Bilder geladen: ${state.images.length}`;
});

function parseCSVData(csvText) {
    state.csvData = csvText.split('\n')
        .filter(line => line.trim() !== '')
        .map(line => {
            const plateMatch = line.match(/[0-9]{10,}\s+([A-ZÄÖÜ0-9-]{2,10})/);
            const imageMatch = line.match(/i\d+\.jpg/i);
            return {
                licensePlate: plateMatch ? plateMatch[1] : '',
                imageName: imageMatch ? imageMatch[0] : ''
            };
        })
        .filter(item => item.licensePlate && item.imageName);
}

function renderTable() {
    if (state.csvData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="2">Keine gültigen Daten</td></tr>';
        return;
    }

    tableBody.innerHTML = '';
    state.csvData.forEach((item, index) => {
        const tr = document.createElement('tr');

        // Spalte Nr.
        const tdNr = document.createElement('td');
        tdNr.textContent = index + 1;
        tr.appendChild(tdNr);

        // Spalte Bild + Kennzeichen darunter
        const tdImage = document.createElement('td');
        const img = document.createElement('img');
        img.className = 'thumbnail';

        const matchFile = state.images.find(f => f.name.toLowerCase() === item.imageName.toLowerCase());
        if (matchFile) {
            img.src = URL.createObjectURL(matchFile);
        } else {
            img.alt = 'Kein Bild gefunden';
        }

        const licenseDisplay = document.createElement('div');
        licenseDisplay.className = 'license-display';
        licenseDisplay.textContent = item.licensePlate;

        tdImage.appendChild(img);
        tdImage.appendChild(licenseDisplay);

        tr.appendChild(tdImage);
        tableBody.appendChild(tr);
    });
}
</script>
</body>
</html>
